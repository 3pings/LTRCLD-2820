{% extends "base_cisco.html" %}
{% from "macros.html" import file, warn, info, cmd_blk_end, cmd_blk_start, term_end, topxterm, term_start, end_of_page,top_instance, copythis %}
{% block content %}
{% set step =  0 %}
{% set innerstep =  0 %}


<div class="section_header">
    <div class="title">Kubernetes Setup</div>
    <div class="title_section">Management</div>
</div>
{{ html_for_step_status|safe }}

<h1>Lab Toplogy</h1>

<img src="/lab/imgman/pod/{{ data.pod_id }}/id/991" class="img-responsive">

<!--
##############################################################################################################################
Step {% set step = step +  1 %}
##############################################################################################################################
-->
<h3>Step {{ step }} - USE CCP API to export kubeconfig file</h3>
<p>SSH using putty to your jumphost at IP address -{{data.pod_master_ip}} or click here -
<a target="_blank" href="chrome-extension://pnhechapfaindjhompbnflcldabbghjo/html/nassh.html#ccpuser@{{data.pod_master_ip}}:22">
<img src="/core/static/images/symbols/ssh_pointer.png" style="height:20px;" >
</a>
<p>Type <b>'yes'</b> if prompted with ssh key validation message</p>
<p>Click 'Copy' on the right to copy the command into your clipboard<br>
<p>The first two commands below get the 'Token' from CCP which in turn is used to extract your pod specific Kubeconfig file.
  The last two commands are for adding the kubeconfig file to your environment variable<br>
<div class="fancy-terminal">
<pre class="command-line language-bash" data-prompt="{{ data.master_prompt}}">
<code class="language-bash">
export TOKEN=$(curl -v -k -X POST -H "Content-Type:application/x-www-form-urlencoded" -d "username=admin&password=admin" https://10.139.13.50/v3/system/login  2> >(grep X-Auth-Token) | grep X-Auth-Token | awk -F ":" '{print $2}' | tr -d '\n\r')
export {{data.apic_stdnt_uname}}id=$(curl -ksSL --request GET -H "X-Auth-Token":"$TOKEN" https://10.139.13.50/v3/clusters/ | jq '.[] | {id: .id, name: .name}' | grep -B1 "{{data.apic_stdnt_uname}}" | awk '/id/{print $2}' | tr -d '\"\,')
curl -ksSL --request GET -H "X-Auth-Token":"$TOKEN" https://10.139.13.50/v3/clusters/${{data.apic_stdnt_uname}}id | jq -r '.kubeconfig' | sed 's/\n/\n/g' > ~/KUBECONFIG.env
export KUBECONFIG=~/KUBECONFIG.env
</code>
</pre>
</div>

<!--
##############################################################################################################################
Step {% set step = step +  1 %}
##############################################################################################################################
-->
<h3>Step {{ step }} - Test kubernetes connection from Jumphost</h3>
<b>Use 'kubectl' to get node and pod information</b>
<div class="fancy-terminal">
<pre class="command-line language-bash" data-prompt="{{ data.master_prompt}}">
<code class="language-bash">
kubectl get nodes -o wide
kubectl get pods --all-namespaces
</code>
</pre>
</div>
<p>The output should look something similar to this.</p>
  <img src="/lab/static/images/ccp/lwall1.png" class="img-responsive img-shadow">



{{ end_of_page(page_position,data) }}
{% endblock %}
